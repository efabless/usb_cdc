
localparam [8*1024-1:0] ROM_DATA = {
                                    256'h6BFF70F634535064F37B754C281F6AF7B0A120A7AB23AA56C72B8196963EA96C,
                                    256'h42C6208931F9F7B53AEA880CEAA9FE57862409104BBD818C5AB791BD6D8C7FD0,
                                    256'h938D70677681B3B17BB4099A1BB55763416D21257784E0F6BA6FE06DCD33D3E4,
                                    256'h6C63F929F5101AE60F9BDFF957EEB6F3D19B13E01F03E5C985BF27626D2F558B,
                                    256'h5339F83366AC213060A7859D1047997BD7FE6E8BD5F5B4D82067C5D10710D50C,
                                    256'hCCE9882D7E404F9A65EBB5712F5D03BF257F8A24CE2AA8D673D091B578E01CCF,
                                    256'h78A3B28FDCA567FD7C1E494E9CA44E637EF41F171812F2B7985FDE8AF23C49D3,
                                    256'hBD0130768D69D1B8846AA10EB590891515B92E41CF67687C68A1E435A13CAE4C,
                                    256'h6CBE32214E032833284B4B0F9E4253064CE2E34CCC05E84BC46866FB66CE94F5,
                                    256'h4E9E80B9F68A5694D7A8E95AC923C45D174585EE74B9F1625F303D947E7D0083,
                                    256'h6012542F5F9565D47A2DD23A660CB63DFE174EC1140CA36C1E1C115BBCC85D55,
                                    256'h795E5E3532529B5BD7E4B0BE2C930B5D20FDDD61EFA6D5A6452EE6B9473E9782,
                                    256'hD33E686024D740D938CDFAA83614CF5874AFD74E6D474305C36EA67365AA055C,
                                    256'h7B1E5A36CB9CB1CE2DC5D30B73108695D7CDAB78F82D9EE0D4E99F5ED63F7E0E,
                                    256'hCB0489AD133571D7602E91DD427CBEE344EC765BFD9DBDA31E7F3790CCC81DC9,
                                    256'h0524D711421DE9A4A337666D52AB2AC6FAA7534177484E1D45DD0302CDC3A5D7,
                                    256'h3A008CCE24134BB43D20668B32DB2AC484DCC6045D9C329C232A11F70C7BA828,
                                    256'h45B708E0CA1D099E0363EF0EA669C7F91FD820AD6877CAE9601B6612810644BC,
                                    256'h7D7ACDD432E5089EDCC656E4D4652FE267F0F3A00BA7C1DCA9CD81C34C403EA0,
                                    256'h669C468BCE8DCF2FD5F62C5CCD2644A4AAD1C2352380224E77B1D420A81C0904,
                                    256'hAB613DF7C993E0CAF52EAE42E6993DCF32D9DD1C43C14D6E0A00A1149E77DFDF,
                                    256'hB3F3875971DED0A8CD7D3367DF3AD14CD8106CA0F311A3CBFEC9B7D14CE9C743,
                                    256'hB47F3FDF0FF66D6D06AD88B97FE20C9A9D4CC152EC2A8AD8500637DB1C307C34,
                                    256'h4D16CB0A455F52B0643EAABE009B386AA5CC0E7531F1436D5295EC3C3B7FB92E,
                                    256'hB0A6E7692B57AEF6AD0F03E84DA205E9AC820E933446500D228009E4E51BBD70,
                                    256'h1716EA292B49BD364EA173086EAC84F0B0D87E2F9BD09B3CAA07867FA09C2FF6,
                                    256'h4B95F3BFF0DE68242A3C41FF2F441E9BC76B6FEFD3F9812E12A332C856F0D2CC,
                                    256'h9944DAB39BDF44376E54AF9AB67C80A903A1A9C8A84BBF5236084CDF748E508D,
                                    256'h6DE345CB3FE6E73AF7188FA1A1E3E0A726040D16F005254CA78113DBE9AA9119,
                                    256'hC16DE7B49C521524B294C2112AFF4F4990B5376173290167D0100627F6352201,
                                    256'h92B6FD8B99387D6E8E946816F2B69E43D3AF99076EC62C89522D895287813755,
                                    256'h84297CF338A4BE852229F37400AC9D68DF2DBB3B09F577B6A553D126DB1D336D};

localparam [8*1024-1:0] RAM_DATA = {
                                    256'h965F9847B4A3BAAA190B4FB0B1194C54F7CEE8534682E23972A4D17E73490A44,
                                    256'hF727D72DD729D0CD105D037E2021A93004BD9F53BC8BDF225701835965F206DB,
                                    256'h068D0DE28F783EB26203DC44E35A6D11FFA95C6E9210649FF491A0C034BF434D,
                                    256'h55B9AD1708FFEAB7CCE5B4812B56BBE8A06AFE1F001218E3A882CE235365D91E,
                                    256'h46A22453D2BE18A44A535FE0B1264C8CF6118C657C09FBE6A8104A9D3F6F0C0B,
                                    256'h14DE92E7AA23677E2AD10897777B09203B94DFB5F548C25C76A3597C18983661,
                                    256'hEB92373356EF7C2A75E7E6A7651360F69F84A94B1EDFCD477B7333C4C3C3EF60,
                                    256'h219772EE578BFD09C6E0A1D2ADD3DD2A93C741656DA7AA154A7DE3221BB2D87B,
                                    256'h6C690E9898AF9C0998F0E38CCCEA7F6112E9DFA2269CF14BC08D277359A56F2F,
                                    256'h3F7C4D85FF7BA37783758E65695A945176847B66B8F1E6EACE04082722EC34CB,
                                    256'h512B05FA953DEE76E256242924D2D6BE76300700D19AD8DAD27AD5766354744A,
                                    256'h8AEEAC224966DDC7AA7FF80C852F87481ABD1346DB794DF8005037E6F8E6B0A6,
                                    256'h7C81B33AD79B57D33D2200FE6671FE13914F5037ACB259DF15B701B93497C0E2,
                                    256'hB49ED4DA4E531C90BED6AA1510BE6AAFCF839D32141FCA8641F82100A0DEC708,
                                    256'hB866EB83C5BBBB172ECC7236B9E874DDA319CBDA30873B63CA4A45B6C6345E5A,
                                    256'hF6C9E12727BE80DD8118E40FEB222AEEE0AF07270F6F144D818C57FE610EACAB,
                                    256'hFFC822D75477EF02E904130A9786E57DDF7EF01E9DD4681F6B82D4A279D86449,
                                    256'h5D55B8FBBFB729BF4A75823157875DD3C81161B3D1684EE466E94D7D219008AC,
                                    256'h6445D7E198A0A9A77D7AAE0B51B4859F702A141426EBEBAA205104120C912736,
                                    256'h623D1C1BFE9B5A4AECD0660AB9CA2792B17D1F07F239CA60F93995505C7AD2F3,
                                    256'hFCD3D657615829842638A3367DF5A1C9958ADD9AA6007E27D8AC9FB511371061,
                                    256'hF8FB05785B1F1E39B9E4CE559A3621E213E65FEE32CC1BFFD855B4827F9C8378,
                                    256'h74BF82DE44D0FBF76776260B18085C5C43496E4C7C8859DDA3D1BC21C05228B3,
                                    256'hD975190C12731DC3313C944EBCA82B6EB16E2D0A9DBFF6D4B4F0422F083AF03C,
                                    256'h5B320AD9577D2434A1F50719CEBA9F30B39148B34FBAA718CD4E513CA1985D3B,
                                    256'h86C9D3361ABA03C988C349CF20F29B42827179BB67A91D268CAFB1F1FEAC32DA,
                                    256'h4996F24C68F7A43EC63B826CA6CAE3CA4F3CE697DC0E13C2F71373D459D9F7B0,
                                    256'h6F4372A89388275E07EC0A7A333F7B7730611D31F9F880F16F3C51E1602ECE96,
                                    256'h37B9F19B4915801797CA558F695F8503BA6C9267229A71510D05A6CDE9900B4A,
                                    256'h84D5735752DAD6E916B43697AE5A9CD789C87B6A80C8A8ED2F000D3D4C3B8683,
                                    256'hDEA7EA885096E84A27B604A2457A077F77772FF4FF2AACBD00770E54367CFAC2,
                                    256'hCD43973FC4A57D8C7DAFC38E7F3D871BBEDA64016961E69A086D64D26E81D4C1};

localparam [7:0] NO_CMD = 8'd0,
                 IN_CMD = 8'd1,
                 OUT_CMD = 8'd2,
                 ADDR_CMD = 8'd3,
                 WAIT_CMD = 8'd4,
                 LFSR_WRITE_CMD = 8'd5,
                 LFSR_READ_CMD = 8'd6,
                 ROM_READ_CMD = 8'd7,
                 RAM_READ_CMD = 8'd8;

function automatic [31:0] crc32;
   input [8*MAX_BYTES-1:0] data;
   input integer           bytes;
   localparam [31:0]       POLY32 = 32'h04C11DB7;
   integer                 i,j;
   begin
      crc32 = 32'hFFFFFFFF;
      for (j = bytes-1; j >= 0; j = j-1) begin
         for (i = 0; i <= 7; i = i+1) begin
            if ((data[8*j+i] ^ crc32[31]) == 1'b1)
              crc32 = {crc32[30:0], 1'b0} ^ POLY32;
            else
              crc32 = {crc32[30:0], 1'b0};
         end
      end
   end
endfunction

`rev(32)

task automatic test_demo_cmd0
  (
   input [6:0]   address,
   input [3:0]   endp,
   input [7:0]   cmd,
   input integer wMaxPacketSize,
   input time    timeout,
   inout [15:0]  dataout_toggle
   );
   begin : u_test_demo_cmd1_task
      test_data_out(address, endp, {8'h00, cmd},
                    2, PID_ACK, wMaxPacketSize, timeout, 0, dataout_toggle);
   end
endtask

task automatic test_demo_cmd1
  (
   input [6:0]   address,
   input [3:0]   endp,
   input [7:0]   cmd,
   input [7:0]   data,
   input integer wMaxPacketSize,
   input time    timeout,
   inout [15:0]  dataout_toggle
   );
   begin : u_test_demo_cmd1_task
      test_data_out(address, endp, {8'h00, cmd, data[7:0]},
                    3, PID_ACK, wMaxPacketSize, timeout, 0, dataout_toggle);
   end
endtask

task automatic test_demo_cmd3
  (
   input [6:0]   address,
   input [3:0]   endp,
   input [7:0]   cmd,
   input [23:0]  data,
   input integer wMaxPacketSize,
   input time    timeout,
   inout [15:0]  dataout_toggle
   );
   begin : u_test_demo_cmd3_task
      test_data_out(address, endp, {8'h00, cmd, data[7:0], data[15:8], data[23:16]},
                    5, PID_ACK, wMaxPacketSize, timeout, 0, dataout_toggle);
   end
endtask

task automatic test_demo_in
  (
   input [6:0]   address,
   input [3:0]   endp,
   input integer bytes,
   input integer wMaxPacketSize,
   input time    timeout,
   input time    wait_time, 
   inout [15:0]  datain_toggle
   );
   localparam    PACKET_TIMEOUT = 6; // TRSPIPD1 (USB2.0 Tab.7-14 pag.188)
   reg           zlp;
   reg [3:0]     packet_pid;
   reg [6:0]     packet_addr;
   reg [3:0]     packet_endp;
   reg [10:0]    packet_frame;
   reg [8*MAX_BYTES-1:0] packet_data;
   reg [8*MAX_BYTES-1:0] device_data;
   time                  start_timeout;
   integer               packet_bytes;
   integer               device_bytes;
   integer               i;
   begin : u_test_demo_in_task
      device_data = 'hX;
      device_bytes = 0;
      start_timeout = $time;
      i = 0;
      zlp = 1'b0;
      while (i < bytes+4 || zlp == 1'b1) begin
         token_tx(PID_IN, address, endp, 8, `BIT_TIME);
         packet_rx(packet_pid, packet_addr, packet_endp, packet_frame, packet_data, packet_bytes, `BIT_TIME, PACKET_TIMEOUT);
         #(1*`BIT_TIME);
         if (packet_pid == PID_DATA0 || packet_pid == PID_DATA1) begin
            // device DATAx
            `assert_error("test_demo_in(): Device DATAx missing", packet_pid, datain_toggle[endp]? PID_DATA1: PID_DATA0)
            if (packet_bytes > 0) begin
               device_data = device_data << 8*packet_bytes;
               packet_data = packet_data >> 8*(MAX_BYTES-packet_bytes);
               device_data = device_data | packet_data;
            end else begin
               if (i != bytes+4) begin
                  `report_error("test_demo_in(): Unexpected ZLP")
               end
            end
            handshake_tx(PID_ACK, 8, `BIT_TIME);
            datain_toggle[endp] = ~datain_toggle[endp];
            i = i + packet_bytes;
            zlp = (i == bytes+4 && packet_bytes == wMaxPacketSize) ? 1'b1 : 1'b0;
            start_timeout = $time;
         end else if (packet_pid == PID_NAK) begin
            if ($time-start_timeout > timeout) begin
               `assert_error("test_demo_in(): Device handshake PID error", packet_pid, PID_ACK)
               disable u_test_demo_in_task;
            end
         end else begin
            // device STALL
            `assert_error("test_demo_in(): Device handshake PID error", packet_pid, PID_ACK)
            disable u_test_demo_in_task;
         end
         #(wait_time);
      end
      `assert_error("CRC32 error", ~rev32(crc32(device_data>>8*4, bytes)),
                    {device_data[7:0], device_data[15:8], device_data[23:16], device_data[31:24]})
   end
endtask

task automatic test_demo_out
  (
   input [6:0]             address,
   input [3:0]             endp,
   input [8*MAX_BYTES-1:0] data,
   input integer           bytes,
   input integer           in_wMaxPacketSize,
   input integer           out_wMaxPacketSize,
   input time              timeout,
   input time              wait_time, 
   inout [15:0]            datain_toggle,
   inout [15:0]            dataout_toggle
   );
   reg [31:0]              crc;
   begin : u_test_demo_out_task
      crc = ~rev32(crc32(data, bytes));
      test_data_out(address, endp, data, bytes, PID_ACK,
                    out_wMaxPacketSize, timeout, wait_time, dataout_toggle);
      test_data_in(address, endp, {crc[7:0], crc[15:8], crc[23:16], crc[31:24]}, 4, PID_ACK,
                   in_wMaxPacketSize, timeout, wait_time, datain_toggle, ZLP);
   end
endtask
